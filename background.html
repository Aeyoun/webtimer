<html>
  <script type="text/javascript">
    // Default domains to check
    var DEFAULT_DOMAINS = [
      "facebook.com",
      "mail.google.com",
      "reddit.com",
      "twitter.com",
      "tumblr.com",
      "youtube.com",
      "hulu.com"
    ].join('\n');
    // Interval (in seconds) to update timer
    var UPDATE_INTERVAL = 3;
    // Add-ons to domains when saving their times
    var ADDON = {
      today: "",
      average: "_avg",
      all: "_all"
    };
    // String representation for "other" category
    var OTHER = "Other";

    setDefaults();
    // Set default settings
    function setDefaults() {
      // Set default domains
      if (!localStorage["domains"]) {
        localStorage["domains"] = DEFAULT_DOMAINS;
      }
      // Set number of days Web Timer has been used
      if (!localStorage["num_days"]) {
        localStorage["num_days"] = 1;
      }
      // Set date
      if (!localStorage["date"]) {
        localStorage["date"] = new Date().toLocaleDateString();
      }
    }

    // Check to make sure data is kept for the same day
    function checkDate() {
      var domains = localStorage["domains"].split(/\n/);
      var todayStr = new Date().toLocaleDateString();
      var saved_day = localStorage["date"];
      if (saved_day !== todayStr) {
        // Reset today's data
        for (var i = 0; i < domains.length; i++) {
          delete localStorage[domains[i] + ADDON.today];
        }
        // Keep track of number of days web timer has been used
        localStorage["num_days"] = parseInt(localStorage["num_days"]) + 1;
        // Update date
        localStorage["date"] = todayStr;
      }

      // REMOVE ME
      if (localStorage["num_days"] === "11") {
        localStorage["num_days"] = 2;
      }
    }

    // Finds the longest match in list of domains being tracked for current URL
    function longestMatch(url) {
      var max = 0;
      var match = null;
      var domains = localStorage["domains"].split(/\n/);
      for (var i = 0; i < domains.length; i++) {
        var domain = domains[i];
        if (url.match(domain) && domain.length > max) {
          match = domain;
          max = domain.length;
        }
      }
      return match;
    }

    // Update the data
    function updateData() {
      // Only count time if Chrome has focus
      chrome.windows.getLastFocused(function (window) {
        if (window.focused) {
          // Only count time if system has not been idle for 60 seconds
          chrome.idle.queryState(60, function (state) {
            if (state === "active") {
              chrome.tabs.getSelected(null, function (tab) {
                // Make sure 'today' is up-to-date
                checkDate();
                var domain = longestMatch(tab.url);
                // Check if domain is being tracked
                if (domain) {
                  // Time tracked for today
                  var todayTime = parseInt(localStorage[domain + ADDON.today]);
                  if (todayTime) {
                    localStorage[domain + ADDON.today] = todayTime + UPDATE_INTERVAL;
                  } else {
                    localStorage[domain + ADDON.today] = UPDATE_INTERVAL;
                  }
                  // Time tracked for all time
                  var totalTime = parseInt(localStorage[domain + ADDON.all]);
                  if (totalTime) {
                    localStorage[domain + ADDON.all] = totalTime + UPDATE_INTERVAL;
                  } else {
                    localStorage[domain + ADDON.all] = UPDATE_INTERVAL;
                  }
                } else {
                  // Track time spent on all non-tracked websites
                  // Time tracked for today
                  var todayTime = parseInt(localStorage[OTHER + ADDON.today]);
                  if (todayTime) {
                    localStorage[OTHER + ADDON.today] = todayTime + UPDATE_INTERVAL;
                  } else {
                    localStorage[OTHER + ADDON.today] = UPDATE_INTERVAL;
                  }
                  // Time tracked for all time
                  var totalTime = parseInt(localStorage[OTHER + ADDON.all]);
                  if (totalTime) {
                    localStorage[OTHER + ADDON.all] = totalTime + UPDATE_INTERVAL;
                  } else {
                    localStorage[OTHER + ADDON.all] = UPDATE_INTERVAL;
                  }
                }
              });
            }
          });
        }
      });
    }
    // Update timer data every second
    setInterval(updateData, UPDATE_INTERVAL * 1000);
  </script>
</html>
