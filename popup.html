<html>
  <head>
    <style type="text/css">
      body {
          width: 400px;
          font-family: helvetica, arial, sans-serif;
          font-size: 13px;
      }
      #nav {
          float: right;
      }
      a {
          text-decoration: none;
          color: black;
      }
      #options {
          font-weight: bold;
          font-size: 10px;
      }
      #options:hover {
          text-decoration: underline;
      }
      #data {
          margin-top: 10px;
      }
      #table_div {
          margin-top: 15px;
      }
      .active {
          font-weight: bold;
      }
      #nodata {
          display: none;
          color: red;
          font-weight: bold;
      }
      #nodata a {
          text-decoration: underline;
          color: red;
      }
    </style>

    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">
      var bg = chrome.extension.getBackgroundPage();

      // Load the Visualization API and the piechart package.
      google.load('visualization', '1.0', {'packages':['corechart', 'table']});
      // Set a callback to run when the Google Visualization API is loaded.
      google.setOnLoadCallback(showToday);

      // Show options in a new tab
      function showOptions() {
        chrome.tabs.create({
          url: 'options.html'
        });
      }

      // Converts duration to String
      function timeString(numSeconds) {
        if (numSeconds === 0) {
          return "0 seconds";
        }
        var remainder = numSeconds;
        var timeStr = "";
        var timeTerms = {
          hour: 3600,
          minute: 60,
          second: 1
        };
        for (term in timeTerms) {
          var divisor = timeTerms[term];
          if (remainder >= divisor) {
            var numUnits = Math.floor(remainder / divisor);
            timeStr += numUnits + " " + term;
            // Make it plural
            if (numUnits > 1) {
              timeStr += "s";
            }
            remainder = remainder % divisor;
            if (remainder) {
              timeStr += " and "
            }
          }
        }
        return timeStr;
      }

      // Show the data for the time period indicated by addon
      function show(addon) {
        // Get the domain data
        var domains = localStorage["domains"].split(/\n/);
        // Add "other" category to domain data
        domains.unshift(bg.OTHER);
        var domain_data = [];
        for (var i = 0; i < domains.length; i++) {
          var domain = domains[i];
          var numSeconds;
          if (addon === bg.ADDON.average) {
            numSeconds = parseInt(localStorage[domain + bg.ADDON.all]);
          } else {
            numSeconds = parseInt(localStorage[domain + addon]);
          }
          if (numSeconds && numSeconds > 0) {
            // Average the time if showing average data
            if (addon === bg.ADDON.average) {
              numSeconds = Math.floor(numSeconds / parseInt(localStorage["num_days"]));
              // Don't show site if average is 0 seconds
              if (numSeconds === 0) {
                continue;
              }
            }
            domain_data.push([domain, numSeconds]);
          }
        }

        // Display help message if no data or data is only for "other" category
        var only_other = (domain_data.length === 1 && domain_data[0][0] === bg.OTHER);
        if (domain_data.length === 0 || only_other) {
          document.getElementById("nodata").style.display = "inline";
        } else {
          document.getElementById("nodata").style.display = "none";
        }

        // Draw the chart
        drawChart(domain_data);

        // Sort data by descending duration before drawing table
        domain_data.sort(function (a, b) {
          return b[1] - a[1];
        });
        // Convert chart data to table data
        for (var i = 0; i < domain_data.length; i++) {
          var numSeconds = domain_data[i][1];
          domain_data[i][1] = timeString(numSeconds);
        }
        // Draw the table
        drawTable(domain_data, addon);
      }

      function showToday() {
        var addon = bg.ADDON.today;
        // Draw chart and table
        show(addon);
        // Update nav
        document.getElementById('today').className = 'active';
        document.getElementById('average').className = '';
        document.getElementById('all').className = '';
      }

      function showAverage() {
        var addon = bg.ADDON.average;
        // Draw chart and table
        show(addon);
        // Update nav
        document.getElementById('today').className = '';
        document.getElementById('average').className = 'active';
        document.getElementById('all').className = '';
      }

      function showAllTime() {
        var addon = bg.ADDON.all;
        // Draw chart and table
        show(addon);
        // Update nav
        document.getElementById('today').className = '';
        document.getElementById('average').className = '';
        document.getElementById('all').className = 'active';
      }

      // Callback that creates and populates a data table, 
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawChart(chart_data) {
        // Create the data table.
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Domain');
        data.addColumn('number', 'Time');
        data.addRows(chart_data);

        // Set chart options
        var options = {
          tooltip: {
            text: 'percentage'
          },
          chartArea: {
            width: 400,
            height: 180
          }
        };

        // Instantiate and draw our chart, passing in some options.
        var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }

      function drawTable(table_data, addon) {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Domain');
        var timeDesc;
        if (addon === bg.ADDON.today) {
          timeDesc = "Today";
        } else if (addon === bg.ADDON.average) {
          timeDesc = "Daily Average";
        } else {
          timeDesc = "Total";
        }
        data.addColumn('string', "Time Spent (" + timeDesc + ")");
        data.addRows(table_data);

        var options = {
          sort: 'disable'
        }
        var table = new google.visualization.Table(document.getElementById('table_div'));
        table.draw(data, options);
      }
    </script>
  </head>

  <body>
    <div id="nav">
      <a id="today" onclick="showToday()" href="#">Today</a>
      &nbsp;|&nbsp;
      <a id="average" onclick="showAverage()" href="#">Average</a>
      &nbsp;|&nbsp;
      <a id="all" onclick="showAllTime()" href="#">All Time</a>
    </div>
    <a id="options" onclick="showOptions()" href="#">Options</a>
    <div id="data">
      <span id="nodata">Start collecting useful data by visiting the <a onclick="showOptions()" href="#">sites you're tracking</a>.</span>
      <div id="chart_div"></div>
      <div id="table_div"></div>
    </div>
  </body>
</html>
